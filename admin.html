<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel Administrativo - GAFIA</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="src/style/style.css">
  <link rel="stylesheet" href="src/style/dashboard.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
      .admin-header { border-bottom: 2px solid #ffd700; }
      
      .kpi-grid { 
          display: grid; 
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
          gap: 20px; 
          margin-bottom: 30px; 
      }
      
      .kpi-card { 
          background: rgba(255,215,0,0.1); 
          border: 1px solid rgba(255,215,0,0.3); 
          padding: 20px; 
          border-radius: 16px; 
          text-align: center; 
      }
      
      .kpi-card h3 { color: #ffd700; font-size: 2rem; margin: 0; }
      .kpi-card p { color: #fff; margin-top: 5px; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }

      .admin-section-title { color: #ffd700; margin-bottom: 15px; }

      /* Estilos específicos para a tabela de admin */
      .admin-table { width: 100%; text-align: left; color: #fff; border-collapse: collapse; }
      .admin-table th { padding: 12px; border-bottom: 1px solid #555; color: #ffd700; }
      .admin-table td { padding: 12px; border-bottom: 1px solid #333; }
      .admin-table tr:hover { background: rgba(255,255,255,0.05); }
      
      /* Inputs do formulário admin */
      .admin-input { padding: 10px; border-radius: 8px; border:none; background: #fff; color: #333; }
  </style>
</head>
<body>
  <header class="site-header admin-header">
    <div class="container header-inner">
      <a class="logo" href="dashboard.html">
        <img src="src/img/Gafialogo.png" alt="Logo" width="54" />
        <span>GAFIA <small style="color:#ffd700; font-size:0.6em; margin-left:5px;">ADMIN</small></span>
      </a>
      <nav class="nav">
        <a href="dashboard.html">Voltar ao Site</a>
        <a href="api/logout.php" class="btn btn-outline">Sair</a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top: 40px; padding-bottom: 40px;">
    <h1>Visão Geral da Empresa</h1>
    <p class="muted" style="margin-bottom: 30px;">Estatísticas globais e gerenciamento.</p>
    
    <div class="kpi-grid">
        <div class="kpi-card">
            <h3 id="kpi-users">0</h3>
            <p>Usuários Cadastrados</p>
        </div>
        <div class="kpi-card">
            <h3 id="kpi-viagens">0</h3>
            <p>Viagens Realizadas</p>
        </div>
        <div class="kpi-card">
            <h3 id="kpi-carros">0</h3>
            <p>Veículos na Plataforma</p>
        </div>
    </div>

    <div class="dashboard-layout">
        <section class="glass dash-card">
            <h3 class="admin-section-title">Top Destinos (Cidades)</h3>
            <div style="height: 300px;">
                <canvas id="chartDestinos"></canvas>
            </div>
        </section>

        <section class="glass dash-card history-card">
            <h3 class="admin-section-title">Top Usuários (Engajamento)</h3>
            <div id="lista-users" class="history-list" style="margin-top:15px;">
                <p>Carregando...</p>
            </div>
        </section>
    </div>

    <section class="glass dash-card" style="margin-top: 30px;">
        <h3 class="admin-section-title">Gerenciar Frota (Master)</h3>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
            <input type="hidden" id="admin-car-id">
            <input type="number" id="admin-marca" class="admin-input" placeholder="ID Marca">
            <input type="number" id="admin-modelo" class="admin-input" placeholder="ID Modelo">
            <input type="number" id="admin-ano" class="admin-input" placeholder="Ano" style="width: 100px;">
            <input type="number" id="admin-bat" class="admin-input" placeholder="Bateria (kWh)" style="width: 120px;">
            
            <button onclick="salvarVeiculoAdmin()" class="btn btn-primary">Salvar</button>
            <button onclick="limparFormAdmin()" class="btn btn-outline">Limpar</button>
        </div>

        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Marca/Modelo</th>
                        <th>Ano</th>
                        <th>Bateria</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="admin-lista-veiculos">
                    </tbody>
            </table>
        </div>
    </section>

  </main>

  <script>
    // --- FUNÇÕES GLOBAIS PARA OS BOTÕES (ONCLICK) ---
    
    function limparFormAdmin() {
        document.getElementById('admin-car-id').value = '';
        document.getElementById('admin-marca').value = '';
        document.getElementById('admin-modelo').value = '';
        document.getElementById('admin-ano').value = '';
        document.getElementById('admin-bat').value = '';
    }

    function editarCarro(dataStr) {
        // Como passamos o objeto como string no HTML, precisamos fazer parse
        // Mas para evitar problemas de aspas, uma abordagem melhor é passar o objeto direto se fosse criado via JS puro.
        // Aqui decodificamos:
        const c = JSON.parse(decodeURIComponent(dataStr));

        document.getElementById('admin-car-id').value = c.id_carro;
        document.getElementById('admin-marca').value = c.id_marca;
        document.getElementById('admin-modelo').value = c.id_modelo;
        document.getElementById('admin-ano').value = c.ano_carro;
        document.getElementById('admin-bat').value = c.dur_bat;
        
        // Scroll suave até o formulário
        document.querySelector('.admin-section-title').scrollIntoView({ behavior: 'smooth' });
    }

    async function salvarVeiculoAdmin() {
        const id = document.getElementById('admin-car-id').value;
        const dados = {
            id_carro: id,
            id_marca: document.getElementById('admin-marca').value,
            id_modelo: document.getElementById('admin-modelo').value,
            ano: document.getElementById('admin-ano').value,
            bateria: document.getElementById('admin-bat').value
        };

        if(!dados.id_marca || !dados.id_modelo || !dados.ano || !dados.bateria) {
            alert("Preencha todos os campos!");
            return;
        }

        const method = id ? 'PUT' : 'POST'; 

        try {
            const req = await fetch('api/admin_veiculos.php', {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
            const res = await req.json();
            
            if(res.error) {
                alert(res.error);
            } else {
                alert(res.message);
                limparFormAdmin();
                carregarFrotaAdmin(); // Recarrega a tabela
            }
        } catch(e) { 
            alert("Erro na requisição. Verifique o console.");
            console.error(e); 
        }
    }

    async function carregarFrotaAdmin() {
        const tbody = document.getElementById('admin-lista-veiculos');
        //tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
        
        try {
            const req = await fetch('api/admin_veiculos.php');
            const carros = await req.json();
            
            tbody.innerHTML = '';
            if(carros.error) { 
                tbody.innerHTML = `<tr><td colspan="5" style="color:red">${carros.error}</td></tr>`; 
                return; 
            }

            if(carros.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5">Nenhum veículo cadastrado.</td></tr>`;
                return;
            }

            carros.forEach(c => {
                // Truque para passar objeto no onclick
                const jsonStr = encodeURIComponent(JSON.stringify(c));
                
                tbody.innerHTML += `
                    <tr>
                        <td>${c.id_carro}</td>
                        <td>${c.nm_marca} ${c.nm_modelo} <small style="color:#aaa">(${c.id_marca}/${c.id_modelo})</small></td>
                        <td>${c.ano_carro}</td>
                        <td>${c.dur_bat} kWh</td>
                        <td>
                            <button onclick="editarCarro('${jsonStr}')" style="cursor:pointer; background:none; border:none; color:#ffd700;" title="Editar">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        } catch(e) { console.error(e); }
    }

    // --- INICIALIZAÇÃO DA PÁGINA ---

    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Verifica sessão e permissão admin
        try {
            const sessionResp = await fetch('api/verificar_sessao.php');
            const session = await sessionResp.json();
            
            // Verifica se está logado E se é admin (convertendo para bool caso venha 0/1 ou string)
            const isAdmin = (session.isAdmin === true || session.isAdmin === "true" || session.isAdmin === 1);

            if (!session.loggedIn || !isAdmin) {
                alert('Acesso restrito! Redirecionando...');
                window.location.href = 'dashboard.html';
                return;
            }
        } catch(e) { 
            console.error("Erro sessão:", e);
            window.location.href = 'login.html'; 
        }

        // 2. Carrega a tabela de veículos
        carregarFrotaAdmin();

        // 3. Busca dados gerais (KPIs e Gráficos)
        try {
            const res = await fetch('api/admin_dados.php');
            const dados = await res.json();

            if(dados.error) { 
                console.error(dados.error); 
                return; 
            }

            // Preenche KPIs
            document.getElementById('kpi-users').innerText = dados.kpis.total_users || 0;
            document.getElementById('kpi-viagens').innerText = dados.kpis.total_viagens || 0;
            document.getElementById('kpi-carros').innerText = dados.kpis.total_carros || 0;

            // Preenche Lista de Usuários
            const lista = document.getElementById('lista-users');
            lista.innerHTML = '';
            
            if (dados.usuarios.length === 0) {
                lista.innerHTML = '<p class="muted">Nenhum dado encontrado.</p>';
            } else {
                dados.usuarios.forEach(u => {
                    lista.innerHTML += `
                        <div class="history-item-mini" style="border-left: 3px solid #ffd700;">
                            <div class="history-icon" style="color:#ffd700; background:rgba(255,215,0,0.1);">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="history-info">
                                <strong style="color: #fff;">${u.nome_completo}</strong>
                                <span>${u.email}</span>
                                <span style="display:block; font-size:0.8em; color:#ffd700;">${u.total_viagens} viagens • ${parseFloat(u.km_total || 0).toFixed(0)} km</span>
                            </div>
                        </div>`;
                });
            }

            // Renderiza Gráfico Chart.js (Destinos)
            const ctx = document.getElementById('chartDestinos').getContext('2d');
            const labels = dados.destinos.map(d => d.cidade_destino);
            const values = dados.destinos.map(d => d.total_viagens);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total de Viagens',
                        data: values,
                        backgroundColor: '#ffd700',
                        borderRadius: 4,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#fff' }, grid: { display: false } }
                    }
                }
            });

        } catch (e) { console.error("Erro dashboard admin:", e); }
    });
  </script>
</body>
</html>